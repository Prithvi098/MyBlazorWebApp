@using static MyBlazorApp.Common.ToastService
@inject ToastService ToastService
@implements IDisposable
@inject IJSRuntime JS
@rendermode InteractiveServer 

<div class="toast-wrapper">
    @foreach (var toast in Toasts)
    {
        <div id="toast-@toast.Id" class="toast show @(toast.IsActive ? "active" : "")">
            <div class="toast-content">
                <i class="fas fa-solid fa-check check"></i>
                <div class="message">
                    <span class="text text-1">@toast.Title</span>
                    <span class="text text-2">@toast.Message</span>
                </div>
            </div>
            <i class="fa-solid fa-xmark close" @onclick="() => CloseToast(toast.Id)"></i>

            <!-- Progress bar with unique animation name -->
            <div class="progress">
                <div class="progress-bar"></div>
            </div>
        </div>
    }
</div>




@code {

    private List<ToastEntry> Toasts = new();


    protected override void OnInitialized()
    {
        ToastService.OnShow += AddToast;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            foreach (var toast in Toasts)
            {
                // Get duration in ms
                var duration = toast.DurationMs;

                // Pass both selector and duration to JS
                await JS.InvokeVoidAsync("startToastProgress", $"#toast-{toast.Id} .toast-progress", duration);
            }
        }
    }

    private void AddToast(ToastEntry entry)
    {
        Toasts.Add(entry);
        InvokeAsync(StateHasChanged);

        _ = Task.Run(async () =>
        {
            await Task.Delay(5000).ContinueWith(_ => CloseToast(entry.Id));

        });
    }

    private void CloseToast(Guid id)
    {
        var toast = Toasts.FirstOrDefault(t => t.Id == id);
        if (toast != null)
        {
            toast.IsActive = false;
            InvokeAsync(StateHasChanged);

            _ = Task.Delay(500).ContinueWith(_ =>
            {
                Toasts.Remove(toast);
                InvokeAsync(StateHasChanged);
            });
        }
    }

    public void Dispose()
    {
        ToastService.OnShow -= AddToast;
    }

}